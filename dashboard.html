<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Mother's Kitchen ‚Äî Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --saffron: #FF9E80;
      /* Peach ladoo */
      --maroon: #C44569;
      /* Rose petal pink */
      --leaf-green: #6AB04C;
      /* Pistachio green */
      --turmeric: #FFEAA7;
      /* Barfi yellow */
      --cream: #FFF5EB;
      /* Light mithai base */
      --gold: #F6C90E;
      /* Saffron-ghee gold */

      --cta-gradient: linear-gradient(90deg, var(--saffron), var(--gold));
      --cta-gradient-alt: linear-gradient(90deg, var(--gold), var(--maroon));
      --wa-gradient: linear-gradient(90deg, #55efc4, #00cec9);
      --wa-gradient-alt: linear-gradient(90deg, #00cec9, #55efc4);
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: var(--cream);
      color: #000;
      padding: 1rem;
    }

    .logo {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--saffron), var(--gold));
      color: var(--maroon);
      font-weight: 700;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      letter-spacing: 1px;
    }

    .logo-img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .brand {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 1px;
    }

    nav {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    nav a {
      color: var(--maroon);
      padding: 8px 16px;
      margin-left: 6px;
      text-decoration: none;
      font-weight: 600;
      border-radius: 999px;
      transition: background 0.18s;
      font-size: 1.05rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    nav a:hover,
    nav a:focus {
      background: rgba(255, 255, 255, 0.25);
      /* gold tint */
    }

    /* CALENDAR */

    .calendar-table {
      border-collapse: collapse;
      width: 100%;
      text-align: center;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .calendar-table th {
      background: var(--maroon);
      color: white;
      padding: 0.75rem;
      font-weight: 600;
      user-select: none;
    }

    .calendar-table td {
      padding: 0.75rem;
      transition: background 0.3s ease;
      cursor: default;
      font-weight: 600;
      user-select: none;
    }

    .calendar-table tr:nth-child(even) td {
      background: var(--turmeric);
    }

    .calendar-table td:hover {
      background: var(--cream);
    }

    .lunch-only {
      background-color: var(--leaf-green) !important;
      color: white;
      border-radius: 6px;
    }

    .dinner-only {
      background-color: var(--saffron) !important;
      color: white;
      border-radius: 6px;
    }

    .both {
      background: linear-gradient(135deg, var(--leaf-green) 50%, var(--saffron) 50%) !important;
      color: white;
      border-radius: 6px;
    }

    /* Legend below calendar in styled card */
    .legend {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-top: 1rem;
      display: flex;
      gap: 1.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      user-select: none;
    }

    .legend-color {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 4px;
      border: 1px solid #333;
      flex-shrink: 0;
    }

    .legend-lunch {
      background-color: var(--leaf-green);
    }

    .legend-dinner {
      background-color: var(--saffron);
    }

    .legend-both {
      background: linear-gradient(135deg, var(--leaf-green) 50%, var(--saffron) 50%);
    }

    /* Buttons with gradient, rounded corners, hover scaling */

    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background: var(--cta-gradient);
      color: rgb(0, 0, 0);
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      user-select: none;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    button:hover,
    button:focus {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      outline: none;
    }

    /* Month label styling */
    #monthLabel {
      font-weight: 700;
      font-size: 1.25rem;
      flex-grow: 1;
      text-align: center;
      min-width: 8rem;
      user-select: none;
      color: #333;
    }

    /* Responsive container for calendar and legend */
    .calendar-legend-container {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
      align-items: center;
      width: 100%;
    }

    /* Make calendar scrollable on small screens */
    #calendar {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      width: 100%;
      max-width: 100%;
      border-radius: 8px;
    }

    /* Remove <br> spacing from legend items */
    .legend-item+.legend-item {
      margin-top: 0.5rem;
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      h2 {
        font-size: 1.5rem;
      }

      .calendar-table th,
      .calendar-table td {
        font-size: 0.9rem;
        padding: 0.5rem;
      }
    }

    @media (max-width: 768px) {
      h2 {
        font-size: 1.3rem;
      }

      .calendar-table th,
      .calendar-table td {
        font-size: 0.8rem;
        padding: 0.4rem;
      }

      #monthLabel {
        font-size: 1rem;
      }

      #downloadCsv {
        font-size: 0.9rem;
        padding: 0.5rem;
        width: 100%;
      }

      .calendar-legend-container {
        gap: 1rem;
      }
    }

    @media (max-width: 480px) {
      h2 {
        font-size: 1.1rem;
      }

      .calendar-table th,
      .calendar-table td {
        font-size: 0.7rem;
        padding: 0.3rem;
      }

      #monthLabel {
        font-size: 0.9rem;
      }

      .legend-item {
        font-size: 0.9rem;
      }

      .legend-color {
        width: 1rem;
        height: 1rem;
      }

      .calendar-nav button {
        font-size: 0.85rem;
        padding: 0.5rem;
      }
    }

    /* Added dashboard container and responsive styles */

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    h2 {
      font-size: 1.75rem;
      margin-bottom: 1rem;
      text-align: center;
      color: var(--maroon);
      user-select: none;
    }

    .calendar-table th,
    .calendar-table td {
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">
      <img src="./Image/1234567890.png" alt="Mother's Kitchen Logo"
        style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />
      <!-- Fallback text if image fails to load -->
      <noscript>MK</noscript>
    </div>
    <div class="brand">Mother's Kitchen</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="admin.html">Admin</a>
      <a href="#" id="logoutBtn">Logout</a>
    </nav>
  </header>

  <!-- CALENDAR -->
  <main class="dashboard-container">
    <h2>Customer Meal Calendar</h2>

    <!-- Month Navigation -->
    <div class="calendar-nav" style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; margin-bottom:1rem;">
      <button id="prevMonth">‚Üê Previous</button>
      <span id="monthLabel"></span>
      <button id="nextMonth">Next ‚Üí</button>
      <button id="downloadCsv">Download CSV</button>
    </div>

    <div class="calendar-legend-container">
      <div id="calendar"></div>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color legend-lunch"></div> Lunch Only
        </div>
        <div class="legend-item">
          <div class="legend-color legend-dinner"></div> Dinner Only
        </div>
        <div class="legend-item">
          <div class="legend-color legend-both"></div> Lunch + Dinner
        </div>
      </div>
    </div>

  </main>

  <script>
    /* ===== Supabase Setup ===== */
    const SUPABASE_URL = "https://ejctvvgkhmoxhuctbbiy.supabase.co"; // üî¥ Replace
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqY3R2dmdraG1veGh1Y3RiYml5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTI3MTAsImV4cCI6MjA3MzY2ODcxMH0.sRpnI_m2GLIuxR40joeUXSBrLPSs3D8gb_o51sgg_ac"; // üî¥ Replace
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let currentData = [];

    async function loadCalendar(year, month) {
      // Fetch all customers_meals entries, joined with customers
      const { data, error } = await supabase
        .from("customers_meals")
        .select("day, lunch, dinner, customers ( id, name, phone )");

      if (error) {
        console.error("Error fetching meals:", error);
        return;
      }

      currentData = data;

      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      // Month label
      const monthLabel = document.getElementById("monthLabel");
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      monthLabel.textContent = `${monthNames[month]} ${year}`;

      // Create table
      const table = document.createElement("table");
      table.classList.add("calendar-table");

      // Table header (days of week)
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].forEach(day => {
        const th = document.createElement("th");
        th.textContent = day;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Table body
      const tbody = document.createElement("tbody");
      let row = document.createElement("tr");

      // Empty cells before first day
      for (let i = 0; i < firstDay.getDay(); i++) {
        row.appendChild(document.createElement("td"));
      }

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
        // Find all meal records for this day
        const records = data.filter(r => r.day === dateStr);

        const cell = document.createElement("td");
        cell.textContent = d;

        if (records && records.length > 0) {
          // If any record has both lunch & dinner, mark as both
          const hasBoth = records.some(r => r.lunch && r.dinner);
          const hasLunch = records.some(r => r.lunch);
          const hasDinner = records.some(r => r.dinner);
          if (hasBoth) {
            cell.classList.add("both");
          } else if (hasLunch) {
            cell.classList.add("lunch-only");
          } else if (hasDinner) {
            cell.classList.add("dinner-only");
          }
        }

        row.appendChild(cell);

        if ((firstDay.getDay() + d) % 7 === 0) {
          tbody.appendChild(row);
          row = document.createElement("tr");
        }
      }

      // Fill remaining cells
      if (row.children.length > 0) {
        while (row.children.length < 7) {
          row.appendChild(document.createElement("td"));
        }
        tbody.appendChild(row);
      }

      table.appendChild(tbody);
      calendar.appendChild(table);
    }

    function downloadCsv() {
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      // Filter data for current month and year
      const filtered = currentData.filter(record => {
        if (!record.day) return false;
        const date = new Date(record.day);
        return date.getFullYear() === currentYear && date.getMonth() === currentMonth;
      });

      // CSV header
      const headers = ['Date', 'Name', 'Phone', 'Lunch', 'Dinner'];
      const rows = [headers.join(',')];

      filtered.forEach(record => {
        const date = record.day;
        const name = record.customers?.name ? `"${record.customers.name.replace(/"/g, '""')}"` : '';
        const phone = record.customers?.phone ? `"${record.customers.phone.replace(/"/g, '""')}"` : '';
        const lunch = record.lunch ? 'Yes' : 'No';
        const dinner = record.dinner ? 'Yes' : 'No';
        rows.push([date, name, phone, lunch, dinner].join(','));
      });

      const csvContent = rows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `meals-${monthNames[currentMonth]}-${currentYear}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // Prev/Next buttons
    document.getElementById("prevMonth").addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      loadCalendar(currentYear, currentMonth);
    });

    document.getElementById("nextMonth").addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      loadCalendar(currentYear, currentMonth);
    });

    document.getElementById("downloadCsv").addEventListener("click", () => {
      downloadCsv();
    });

    /* ===== Check User Session ===== */
    async function checkUser() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "index.html";
      } else {
        await loadCalendar(currentYear, currentMonth);
        history.pushState({}, "", window.location.href);
      }
    }

    checkUser();

    // Popstate: sign out and redirect if back button is pressed
    window.addEventListener("popstate", async () => {
      await supabase.auth.signOut();
      history.replaceState(null, "", location.href);
      window.location.href = "index.html";
    });

    // Pageshow: check user session on page show (browser cache restore, etc.)
    window.addEventListener("pageshow", async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        await supabase.auth.signOut();
        window.location.href = "index.html";
      }
    });

    /* ===== Logout Button ===== */
    document.getElementById("logoutBtn").addEventListener("click", async (e) => {
      e.preventDefault();
      const { error } = await supabase.auth.signOut();
      if (error) {
        alert("Error logging out: " + error.message);
      } else {
        window.location.href = "index.html";
      }
    });
  </script>
</body>

</html>